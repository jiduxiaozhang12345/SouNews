<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script>
        var myDB = {
            name: "helloindexDB",
            version: 1,
            db: null
        };

        var students = [{
            id: 101,
            name: "aa",
            age: 11
        }, {
            id: 102,
            name: "bb",
            age: 11
        }, {
            id: 103,
            name: "cc",
            age: 11
        }, {
            id: 104,
            name: "dd",
            age: 14
        }];

        function openDB(name, version) {
            var version = version || 1;
            var request = window.indexedDB.open(name, version);
            request.onerror = function (e) {

            }
            request.onsuccess = function (e) {
                myDB.db = e.target.result;
            }
            request.onupgradeneeded = function (e) {
                var db = e.target.result;
                if (!db.objectStoreNames.contains("students")) {
                    var store = db.createObjectStore("students", { keyPath: "id" });
                    store.createIndex("nameIndex", "name", { unique: true });
                    store.createIndex("ageIndex", "age", { unique: false });
                }
            }
        }

        function addData(db, storeName) {
            var transaction = db.transaction(storeName, "readwrite");
            var store = transaction.objectStore(storeName);
            for (var i = 0; i < students.length; i++) {
                store.add(students[i]);
            }
        }

        openDB(myDB.name, myDB.version);
        setTimeout(function () {
            addData(myDB.db, "students");
        }, 1000);

        //通过姓名索引获取数据
        function getDataByIndexName(db, storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("nameIndex");
            index.get("aa").onsuccess = function (e) {
                var student = e.target.result;
                //console.log("nameIndex：" + student.name + "--" + student.age + "--" + student.id);
            };
        }
        setTimeout(function () {
            getDataByIndexName(myDB.db, "students");
        }, 1000);

        //通过年龄索引获取数据
        function getDataByIndexAge(db, storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("ageIndex");
            //多个11，但只取出一个
            index.get(11).onsuccess = function (e) {
                var student = e.target.result;
                //console.log("ageIndex：" + student.name + "--" + student.age + "--" + student.id);
            };
        }
        setTimeout(function () {
            getDataByIndexAge(myDB.db, "students");
        }, 1000);

        //游标
        function fetchStoreByCursor(db, storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var request = store.openCursor();
            request.onsuccess = function (e) {
                var cursor = e.target.result;
                if (cursor) {
                    //console.log(cursor.key);
                    var currentStudent = cursor.value;
                    //console.log(currentStudent.name);
                    //游标下移，获取下一条数据
                    cursor.continue();
                }
            }
        }
        setTimeout(function () {
            fetchStoreByCursor(myDB.db, "students");
        }, 1000);


        //index与游标配合
        function getDataByCursor(db,storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("ageIndex");
            var request = index.openCursor(IDBKeyRange.only(11));
            request.onsuccess = function (e) {
                var cursor = e.target.result;
                if (cursor) {
                    var student = cursor.value;
                    //console.log(student.id);
                    cursor.continue();
                }
            };
        }
        setTimeout(function () {
            getDataByCursor(myDB.db,"students");
        }, 500);

        //根据游标范围获取数据
        //IDBKeyRange.only(value); 只获取指定数据
        //IDBKeyRange.lowerBound(value,isopen); 获取最小是value,第二个参数用来表示是否包含最小值本身(即value为5，是否包含5)
        //IDBKeyRange.upperBound(value,isopen); 
        //IDBKeyRange.bound(value1,value2,isopen1,isopen2)
        function getDataByCursorRange(db,storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("nameIndex");
            var request = index.openCursor(IDBKeyRange.bound("b","z",false,true));
            request.onsuccess = function (e) {
                var cursor = e.target.result;
                if (cursor) {
                    var student = cursor.value;
                    console.log(student.id);
                    cursor.continue();
                }
            };
        }
        setTimeout(function () {
            getDataByCursorRange(myDB.db, "students");
        }, 500);
    </script>
</head>
<body>

</body>
</html>
